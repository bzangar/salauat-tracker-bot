name: CI/CD - Spring Boot Docker Deploy

on:
  push:
    branches:
      - main  # –¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º JDK –¥–ª—è Maven (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Docker build, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      # 3. –°—Ç—Ä–æ–∏–º Docker-–æ–±—Ä–∞–∑ –Ω–∞ GitHub Actions


      # 4. –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä (docker-compose.yml + Dockerfile)
      - name: Copy project to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "."
          target: "~/salauat_bot"

      # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º docker-compose –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: Deploy on server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/salauat_bot
            echo "üßπ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            sudo docker compose down || true

            echo "üöÄ –°–æ–±–∏—Ä–∞—é –∏ –∑–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ—Ä–µ–∑ docker-compose..."
            sudo docker compose up -d --build

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
